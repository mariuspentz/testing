<script runat="server">
  Platform.Load("Core", "1");
  try {
</script>
%%[
var @newslettersubscriber,@loyaltynewslettersubscriber,@directmail,@unsubscribefromall,@todaydate,@myNLSub,@myLoyaltyNLSub,@NLFinalUnsubReason,@LNLFinalUnsubReason,@NLotherReason,@LNLotherReason

set @newslettersubscriber=RequestParameter("newslettersubscriber")
set @loyaltynewslettersubscriber=RequestParameter("loyaltynewslettersubscriber")
set @regid=RequestParameter("regId")
  
set @NewsletterUnsubscribeDate=RequestParameter("NewsletterUnsubscribeDate")
set @LoyaltyNewsletterUnsubscribeDate=RequestParameter("LoyaltyNewsletterUnsubscribeDate")

set @formatdate=DateAdd(Now(), 6, "H")
set @todaydate=Replace(FormatDate(@formatdate,"yyyy-MM-ddT","hh:mm:ss"),' ','')

set @newslettersubscriber = "false"
set @loyaltynewslettersubscriber = "false"



/*
IF NOT EMPTY (@regId) THEN         

//LOOKUP - Synched DE Registrations und Pref Lang holen
set @lang = LookUp("Registration__c_Salesforce_7","RegistrationCountry__c","Account__c",@
*/
set @result=UpdateSingleSalesforceObject(
                                                   "Registration__c",@regid,
                                                   "NewsletterSubscriber__c",@newslettersubscriber,
                                                   "LoyaltyNewsletterSubscriber__c",@loyaltynewslettersubscriber,
                                                   "NewsletterUnsubscribeDate__c",@todaydate,
                                                   /*"LoyaltyNewsletterUnsubscribeDate",@todaydate */
                                                 )
        set @nullresult1=UpdateSingleSalesforceObject('Registration__c', @regid, 'fieldsToNull', 'NewsletterSubscriptionDate__c')
        set @nullresult2=UpdateSingleSalesforceObject('Registration__c', @regid, 'fieldsToNull', 'LoyaltyNewsletterSubscriptionDate__c')

        ]%%
 /*       ELSE
// IF REGID == EMPTY -> RETRIEVESFOBJECT
set @ContactId=RequestParameter("Contact")
set @regCountry=RequestParameter("RegCountry")

SET @subscriberRows = RetrieveSalesforceObjects("Contact","Id,FirstName,Email,Mailingcountry,AccountId","Id", "=",@ContactId)

IF RowCount(@subscriberRows) > 0 THEN
 SET @row = row(@subscriberRows,1)
 SET @FirstName = field(@row,"FirstName")
 SET @Email = field(@row,"Email")
 SET @country = field(@row,"Mailingcountry")
 SET @AccountId=field(@row,"AccountId")

 SET @regRows=RetrieveSalesforceObjects("Registration__c",
                                     "Id,NewsletterSubscriber__c,LoyaltyNewsletterSubscriber__c,PreferredLanguage__c,NewsletterSubscriptionDate__c,NewsletterUnsubscribeDate__c ,LoyaltyNewsletterSubscriptionDate__c,LoyaltyNewsletterUnsubscribeDate__c,LoyaltyEnrolmentChannel__c,NewsletterEnrolmentChannel__c,NLDoubleOptIn__c,LoyaltyNLDoubleOptIn__c",
                                      "Account__c", "=", @AccountId,"RegistrationCountry__c","=",@regCountry,"Brand__c","=","Triumph")
  
  IF RowCount(@regRows) > 0 THEN
  SET @regrow = row(@regRows,1)
  SET @registrationId=field(@regrow,"Id")
  SET @sfdcNewsletterSubscriber = field(@regrow,"NewsletterSubscriber__c")
  SET @sfdcLoyaltyNewsletterSubscriber = field(@regrow,"LoyaltyNewsletterSubscriber__c") 
 
  SET @NewsletterSubscriptionDate = field(@regrow,"NewsletterSubscriptionDate__c") 
  SET @NewsletterUnsubscribeDate = field(@regrow,"NewsletterUnsubscribeDate__c") 
  SET @LoyaltyNewsletterSubscriptionDate = field(@regrow,"LoyaltyNewsletterSubscriptionDate__c") 
  SET @LoyaltyNewsletterUnsubscribeDate = field(@regrow,"LoyaltyNewsletterUnsubscribeDate__c")
  
  SET @NewsletterEnrolmentChannel = field(@regrow,"NewsletterEnrolmentChannel__c") 
  SET @LoyaltyEnrolmentChannel = field(@regrow,"LoyaltyEnrolmentChannel__c") 
  
  set @sfdcNLDoubleOptIn=field(@regrow,"NLDoubleOptIn__c") 
  set @sfdcLNLDoubleOptIn=field(@regrow,"LoyaltyNLDoubleOptIn__c") 
  
  SET @lang=field(@regrow,"PreferredLanguage__c")

 /* set @result=UpdateSingleSalesforceObject(
                                                   "Registration__c",@registrationId,
                                                   "NewsletterSubscriber__c",@newslettersubscriber,
                                                   "LoyaltyNewsletterSubscriber__c",@loyaltynewslettersubscriber,
                                                   "NewsletterUnsubscribeDate__c",@todaydate,
                                                   "LoyaltyNewsletterUnsubscribeDate",@todaydate
                                                 )
        //set @nullresult1=UpdateSingleSalesforceObject('Registration__c', @regid, 'fieldsToNull', 'NewsletterSubscriptionDate__c')
        // LOYALTYNEWSLETTERSUBSCRIPTIONDATE AUCH NULLEN???
  */
 /*       ENDIF
  ENDIF 
 ENDIF 
var @rows,@rowCount,@i,@row
set @rows = LookupRows("Translation_Page_Triumph","langg", @lang)

var @transHeader1,@transName,@transEmail,@transPreferredLanguage,@transLoyaltyID,@transDateOfBirth,@transUnsubscribeReason,@transHeader2,@transOption1,@transOption2,@transOption3,@transHeader3,@transOption10,@transOption10,@transHeader3,@transSubmit,@transThankyou,@transErrorMsg
   set @rowCount = rowcount(@rows)
 if @rowCount > 0 then
   for @i = 1 to @rowCount do
   
   set @row = row(@rows, @i) /* get row based on counter */
 /*  set @transHeader1 = field(@row,"Header1")
   set @transEmail = field(@row,"Email")
   set @transHeader2 = field(@row,"Header2")
   set @transOption1 = field(@row,"Option1")
   set @transOption2 = field(@row,"Option2")
   set @transSubmit = field(@row,"Submit") 
   set @transThankyou = field(@row,"Thankyou")
   set @transErrorMsg = field(@row,"ErrorMsg")
   set @transOption11 = field(@row,"Option11")
   set @transReason1 = field(@row,"Reason1")
   set @transReason2 = field(@row,"Reason2")
   set @transReason3 = field(@row,"Reason3")
   set @transReason4 = field(@row,"Reason4")
   
next @i

endif 

]%%

%%[if RequestParameter("debug") == "true" then]%%
ContactID: %%=v(@ContactId)=%%<br>
RegCountry: %%=v(@regCountry)=%%<br>
%%[endif]%%

*/
<script runat="server">
      } catch(e) { 
        
        Variable.SetValue("@Error_desc","true");
        Variable.SetValue("@Error_desc_detail",Stringify(e.message)+Stringify(e.description));
        Write(Stringify(e));
      }
</script>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  %%=v(@newslettersubscriber)=%% <br>
%%=v(@loyaltynewslettersubscriber)=%% <br>
%%=v(@regid)=%% <br>

%%=v(@NewsletterUnsubscribeDate)=%% <br>
%%=v(@LoyaltyNewsletterUnsubscribeDate)=%% <br>

%%=v(@formatdate)=%% <br>
%%=v(@todaydate)=%% <br>

%%=v(@newslettersubscriber)=%% <br>
%%=v(@loyaltynewslettersubscriber)=%% <br>
Hello World!
</body>
</html>
