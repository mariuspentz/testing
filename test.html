<script runat="server">
  Platform.Load("Core", "1");
  try {
</script>
%%[
var @newslettersubscriber,@loyaltynewslettersubscriber,@directmail,@unsubscribefromall,@todaydate,@myNLSub,@myLoyaltyNLSub,@NLFinalUnsubReason,@LNLFinalUnsubReason,@NLotherReason,@LNLotherReason

set @regid = RequestParameter("regId")
set @subKey = _subscriberkey

set @formatdate=DateAdd(Now(), 6, "H")
set @todaydate=Replace(FormatDate(@formatdate,"yyyy-MM-ddT","hh:mm:ss"),' ','')

set @newslettersubscriber = "false"
set @loyaltynewslettersubscriber = "false"

set @ContactId=RequestParameter("Contact")
set @regCountry=RequestParameter("RegCountry")


IF EMPTY (@regid) AND NOT EMPTY (@subKey)  THEN

  SET @subscriberRows = RetrieveSalesforceObjects("Contact","Id,FirstName,Email,Mailingcountry,AccountId","Id", "=",@ContactId)

    IF RowCount(@subscriberRows) > 0 THEN
      SET @row = row(@subscriberRows,1)
      SET @FirstName = field(@row,"FirstName")
      SET @Email = field(@row,"Email")
      SET @country = field(@row,"Mailingcountry")
      SET @AccountId=field(@row,"AccountId")


      SET @regRows=RetrieveSalesforceObjects("Registration__c",
                                          "Id,NewsletterSubscriber__c,LoyaltyNewsletterSubscriber__c,PreferredLanguage__c,NewsletterSubscriptionDate__c,NewsletterUnsubscribeDate__c ,LoyaltyNewsletterSubscriptionDate__c,LoyaltyNewsletterUnsubscribeDate__c,LoyaltyEnrolmentChannel__c,NewsletterEnrolmentChannel__c,NLDoubleOptIn__c,LoyaltyNLDoubleOptIn__c",
                                            "Account__c", "=", @AccountId,"RegistrationCountry__c","=",@regCountry,"Brand__c","=","Triumph")
        
      IF RowCount(@regRows) > 0 THEN
        SET @regrow = row(@regRows,1)
        SET @registrationId=field(@regrow,"Id")
        SET @ecomSubscriber = field(@regrow,"NewsletterSubscriber__c")
        SET @loyaltySubscriber = field(@regrow,"LoyaltyNewsletterSubscriber__c") 
      
        SET @NewsletterSubscriptionDate = field(@regrow,"NewsletterSubscriptionDate__c") 
        SET @NewsletterUnsubscribeDate = field(@regrow,"NewsletterUnsubscribeDate__c") 
        SET @LoyaltyNewsletterSubscriptionDate = field(@regrow,"LoyaltyNewsletterSubscriptionDate__c") 
        SET @LoyaltyNewsletterUnsubscribeDate = field(@regrow,"LoyaltyNewsletterUnsubscribeDate__c")
        
        SET @lang=field(@regrow,"PreferredLanguage__c")

        IF @ecomSubscriber = 'true' THEN
  
          var @NLdoiDate,@NLdoiFlag
          SET @NLdoiDate = ""        
          SET @NLdoiFlag = ""
          set @newslettersubscriber = "false"
          set @loyaltynewslettersubscriber = "false"
  /*
          set @result=UpdateSingleSalesforceObject(
            "Registration__c",@registrationId,
            "NewsletterSubscriber__c",@newslettersubscriber,
            "NewsletterUnsubscribeDate__c",@todaydate,
            "NLDoubleOptInDate__c",@NLdoiDate,
            "NLDoubleOptIn__c",@NLdoiFlag   
          )
          set @nullresult1=UpdateSingleSalesforceObject('Registration__c', @regid, 'fieldsToNull', 'NewsletterSubscriptionDate__c')
*/
        ENDIF

          IF @loyaltySubscriber = 'true' THEN

            var @LNLdoiDate,@LNLdoiFlag
            SET @LNLdoiDate="" 
            SET @LNLdoiFlag=""
            set @newslettersubscriber = "false"
            set @loyaltynewslettersubscriber = "false"
/*    
            set @result=UpdateSingleSalesforceObject(
              "Registration__c",@registrationId,
              "LoyaltyNewsletterSubscriber__c",@loyaltynewslettersubscriber,
              "LoyaltyNewsletterUnsubscribeDate__c",@todaydate,
              "LoyaltyNLDoubleOptInDate__c",@LNLdoiDate,
              "LoyaltyNLDoubleOptIn__c",@LNLdoiFlag
            )
            set @nullresult2=UpdateSingleSalesforceObject('Registration__c', @regid, 'fieldsToNull', 'LoyaltyNewsletterSubscriptionDate__c')  
*/
          ENDIF
      ENDIF 
      ENDIF 
      ENDIF
      ]%%  /*
      ENDIF
    ENDIF
ENDIF
/* ELSEIF NOT EMPTY (@subKey) THEN

  //LOOKUP auf Registration synched DE fÃ¼r subscriptions anhand Id
  set @regDE = "Registration__c_Salesforce_7"

  set @ecomSubscriber = Lookup(@regDE,"NewsletterSubscriber__c", "Id", @regid)
  set @loyaltySubscriber = Lookup(@regDE,"LoyaltyNewsletterSubscriber__c", "Id", @regid)

  var @LNLdoiDate,@LNLdoiFlag
  SET @LNLdoiDate="" 
  SET @LNLdoiFlag=""

    IF @ecomSubscriber = 'true' THEN
      set @result=UpdateSingleSalesforceObject(
      "Registration__c",@registrationId,
      "NewsletterSubscriber__c",@newslettersubscriber,
      "NewsletterUnsubscribeDate__c",@todaydate,
      "NLDoubleOptInDate__c",@NLdoiDate,
      "NLDoubleOptIn__c",@NLdoiFlag   
      )
      set @nullresult1=UpdateSingleSalesforceObject('Registration__c', @regid, 'fieldsToNull', 'NewsletterSubscriptionDate__c')
    ENDIF

    IF @loyaltySubscriber = 'true' THEN
      set @result=UpdateSingleSalesforceObject(
        "Registration__c",@registrationId,
        "LoyaltyNewsletterSubscriber__c",@loyaltynewslettersubscriber,
        "LoyaltyNewsletterUnsubscribeDate__c",@todaydate,
        "LoyaltyNLDoubleOptInDate__c",@LNLdoiDate,
        "LoyaltyNLDoubleOptIn__c",@LNLdoiFlag
      )
      set @nullresult2=UpdateSingleSalesforceObject('Registration__c', @regid, 'fieldsToNull', 'LoyaltyNewsletterSubscriptionDate__c')  
    ENDIF

ELSE

  SET @unsubTrans = "Error. Please contact customer service."
  
ENDIF
]%%
*/
%%[
var @rows,@rowCount,@i,@row

set @lang = "de_de"

set @rows = LookupRows("Translation_Page_Triumph","Language", @lang)

var @transHeader1,@transName,@transEmail,@transPreferredLanguage,@transLoyaltyID,@transDateOfBirth,@transUnsubscribeReason,@transHeader2,@transOption1,@transOption2,@transOption3,@transHeader3,@transOption10,@transOption10,@transHeader3,@transSubmit,@transThankyou,@transErrorMsg
   set @rowCount = rowcount(@rows)
 if @rowCount > 0 then
    for @i = 1 to @rowCount do
    
    set @row = row(@rows, @i) 
    set @transHeader1 = field(@row,"Header1")
    set @transEmail = field(@row,"Email")
    set @transHeader2 = field(@row,"Header2")
    set @transOption1 = field(@row,"Option1")
    set @transOption2 = field(@row,"Option2")
    set @transSubmit = field(@row,"Submit") 
    set @transThankyou = field(@row,"Thankyou")
    set @transErrorMsg = field(@row,"ErrorMsg")
    set @transOption11 = field(@row,"Option11")
    set @transReason1 = field(@row,"Reason1")
    set @transReason2 = field(@row,"Reason2")
    set @transReason3 = field(@row,"Reason3")
    set @transReason4 = field(@row,"Reason4")
    set @unsubTrans = field(@row,"unsubTrans")
    
    next @i

  endif 

]%%
<script runat="server">
      } catch(e) { 
        
        Variable.SetValue("@Error_desc","true");
        Variable.SetValue("@Error_desc_detail",Stringify(e.message)+Stringify(e.description));
        Write(Stringify(e));
      }
</script>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body style="margin-left: 30px;">

<br>
Content:<br>
Trans: %%=v(@unsubTrans)=%% <br>
SK: %%=v(@subKey)=%% <br>
lang: %%=v(@lang)=%% <br>
</body>
</html>
